name: VPS AutomÃ¡tica com Backup e Tailscale

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # executa a cada 6 horas

jobs:
  vps:
    runs-on: windows-latest
    timeout-minutes: 360  # 6h

    steps:
      - name: ğŸ“¦ Baixar repositÃ³rio
        uses: actions/checkout@v4

      # ğŸ§© Restaura o backup da Ã¡rea de trabalho
      - name: ğŸ’¾ Restaurar backup anterior (Ãrea de Trabalho)
        uses: actions/download-artifact@v4
        with:
          name: vps-backup
          path: ${{ env.USERPROFILE }}\Desktop
        continue-on-error: true

      # ğŸŒ€ Instalar e conectar ao Tailscale
      - name: ğŸ”— Conectar ao Tailscale
        shell: powershell
        run: |
          Write-Host "Instalando Tailscale..."
          try {
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup.exe" -OutFile "tailscale-setup.exe" -UseBasicParsing
          } catch {
            Write-Host "âš ï¸ Falha ao baixar Tailscale. Tentando novamente..."
            Start-Sleep -Seconds 5
            Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup.exe" -OutFile "tailscale-setup.exe" -UseBasicParsing
          }

          if (-Not (Test-Path "tailscale-setup.exe")) {
            throw "âŒ Falha ao baixar o instalador do Tailscale!"
          }

          Write-Host "âœ… Instalador baixado com sucesso. Instalando..."
          Start-Process -FilePath "tailscale-setup.exe" -Wait

          Write-Host "ğŸ”— Conectando ao Tailscale..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey ${{ secrets.TAILSCALE_KEY }} --hostname vps-auto --accept-routes --ssh

      # ğŸ”’ Define uma senha fixa para o usuÃ¡rio padrÃ£o
      - name: ğŸ”’ Definir senha fixa
        shell: powershell
        run: |
          $senha = "@vps123"
          net user runneradmin $senha
          Write-Host "âœ… Senha fixa definida: $senha"

      # ğŸ–¥ï¸ Mostrar informaÃ§Ãµes de acesso
      - name: ğŸªª Mostrar credenciais RDP
        shell: powershell
        run: |
          Write-Host "=============================="
          Write-Host "ğŸ’» UsuÃ¡rio: runneradmin"
          Write-Host "ğŸ”‘ Senha: @vps123"
          Write-Host "ğŸŒ Use o IP do Tailscale pra conectar via RDP"
          Write-Host "=============================="

      # ğŸŸ¢ MantÃ©m a VPS ativa por 6h
      - name: â³ Mantendo VPS ativa
        shell: powershell
        run: |
          Write-Host "Mantendo VPS ativa por 6 horas..."
          Start-Sleep -Seconds 21600

      # ğŸ’¾ Faz backup da Ãrea de Trabalho ao final
      - name: ğŸ’½ Fazer backup da Ãrea de Trabalho
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup
          path: ${{ env.USERPROFILE }}\Desktop
