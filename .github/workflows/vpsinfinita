name: VPS Windows Infinita com Backup + Tailscale

on:
  schedule:
    - cron: "0 */6 * * *"  # Executa automaticamente a cada 6h
  workflow_dispatch:        # TambÃ©m pode ser iniciada manualmente

jobs:
  vps:
    runs-on: windows-latest
    timeout-minutes: 360  # MantÃ©m ativa por 6 horas (360 min)

    steps:
      - name: ğŸ“ Baixar repositÃ³rio
        uses: actions/checkout@v4

      # ğŸ”„ Restaura o backup anterior, se existir
      - name: ğŸ”„ Restaurar backup anterior (Ãrea de Trabalho)
        uses: actions/download-artifact@v4
        with:
          name: backup-desktop
          path: "C:\\Users\\runneradmin\\Desktop"
        continue-on-error: true

      # âš™ï¸ Instala e conecta Tailscale
      - name: ğŸŒ Conectar ao Tailscale
        run: |
          Write-Host "Instalando Tailscale..."
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile tailscale.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/i tailscale.msi /quiet'
          tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --hostname planny-vps --accept-routes --ssh
          tailscale ip -4
          Write-Host "âœ… Tailscale conectado. Agora tu pode acessar via IP acima."

      # â³ MantÃ©m a VPS rodando por 6 horas
      - name: ğŸ•“ Mantendo VPS ativa
        run: |
          Write-Host "A VPS ficarÃ¡ ativa por 6 horas. Tudo que salvar na Ãrea de Trabalho serÃ¡ preservado."
          Start-Sleep -Seconds 21600  # 6h

      # ğŸ’¾ Faz backup automÃ¡tico da Ãrea de Trabalho antes de expirar
      - name: ğŸ’¾ Fazer backup da Ãrea de Trabalho
        uses: actions/upload-artifact@v4
        with:
          name: backup-desktop
          path: "C:\\Users\\runneradmin\\Desktop"
